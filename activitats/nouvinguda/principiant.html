<!DOCTYPE html>
<html lang="cat">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Activitats: La nouvinguda (Principiant) - Afers Juvenils</title>
  <link rel="icon" type="image/png" href="images/icon.png" />

  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet" />

  <!-- Tailwind CSS (CDN per a prototip) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Els teus estils personalitzats -->
  <link rel="stylesheet" href="../../style.css" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <div class="text-2xl font-bold text-primary">Afers Juvenils</div>
                </div>
                <nav class="hidden md:flex space-x-8">
                    <a href="../../index.html" class="nav-link text-gray-800 hover:text-gray-600 font-medium">Inici</a>
                    <a href="../../entrevistes.html" class="nav-link text-gray-800 hover:text-gray-600 font-medium">Entrevistes</a>
                    <a href="../../guia.html" class="nav-link text-gray-800 hover:text-gray-600 font-medium">Guia Didàctica</a>
                    <a href="../../activitats.html" class="nav-link text-gray-800 hover:text-gray-600 font-medium active">Activitats</a>
                    <a href="../../tastet.html" class="nav-link text-gray-800 hover:text-gray-600 font-medium">Un Tastet</a>
                    <a href="../../autora.html" class="nav-link text-gray-800 hover:text-gray-600 font-medium">L'Autora</a>
                </nav>
                <div class="md:hidden">
                    <button id="menu-toggle" class="text-gray-800 focus:outline-none">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-white shadow-lg">
            <div class="px-4 py-3 space-y-3">
                <a href="../../index.html" class="block text-gray-800 hover:text-gray-600 font-medium">Inici</a>
                <a href="../../entrevistes.html" class="block text-gray-800 hover:text-gray-600 font-medium">Entrevistes</a>
                <a href="../../guia.html" class="block text-gray-800 hover:text-gray-600 font-medium">Guia Didàctica</a>
                <a href="../../activitats.html" class="block text-gray-800 hover:text-gray-600 font-medium">Activitats</a>
                <a href="../../tastet.html" class="block text-gray-800 hover:text-gray-600 font-medium">Un Tastet</a>
                <a href="../../autora.html" class="block text-gray-800 hover:text-gray-600 font-medium">L'Autora</a>
            </div>
        </div>
    </header>

<main class="container mx-auto px-4 py-8">
    <!-- Contenidor principal de l'activitat. El JS llegirà els atributs data-* -->
    <div id="activity-wrapper" 
         data-story-title="La nouvinguda" 
         data-story-id="nouvinguda" 
         data-level-text="Principiant">

        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
            <a href="../../activitats.html" class="flex items-center text-primary font-medium hover:text-accent transition">
                <i class="fas fa-arrow-left mr-2"></i> Tornar a la selecció d'activitats
            </a>
            <div class="text-left sm:text-right">
                <h1 id="activity-story-title" class="text-3xl font-bold text-primary">La nouvinguda</h1>
                <p id="activity-level" class="text-accent font-medium text-lg">Nivell Principiant</p>
            </div>
        </div>

        <div id="name-input-container" class="bg-white rounded-xl shadow-lg p-8 text-center">
            <h3 class="text-2xl font-bold mb-4 text-primary">Abans de començar...</h3>
            <p class="text-gray-700 mb-6">Si us plau, introdueix el teu nom i cognoms per poder generar el justificant al final.</p>
            <input type="text" id="student-name" placeholder="El teu nom i cognoms" class="w-full max-w-md mx-auto p-3 border-2 border-gray-300 rounded-lg focus:border-accent focus:outline-none transition">
            <button id="start-activities-btn" class="mt-4 bg-primary text-white font-bold py-3 px-8 rounded-lg hover:bg-opacity-90 transition disabled:bg-gray-400 disabled:cursor-not-allowed">Començar Activitats</button>
        </div>

        <div id="main-activity-content" class="hidden">
            <div class="mb-8">
                <div class="flex justify-between mb-1">
                    <span class="text-base font-medium text-primary">Progrés</span>
                    <span id="progress-text" class="text-sm font-medium text-primary">Pas 0 / 0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-accent h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- AQUEST ÉS L'ÚNIC BLOC D'ACTIVITATS D'AQUESTA PÀGINA -->
            <div id="activity-nouvinguda-principiant" class="activity-set">
                <!-- Activitat 1: Tipus de narradors -->
                <div class="activity-step" data-step-id="narradors" data-step-title="Tipus de narradors">
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h4 class="text-xl font-bold mb-1 text-primary">Activitat 1: Tipus de narradors</h4>
                        <p class="text-gray-600 mb-6">Arrossega cada paraula al seu lloc correcte per completar la frase.</p>
                        <p class="text-lg leading-loose bg-secondary/30 p-6 rounded-lg mb-6">
                            Si utilitzem el punt de vista intern, al narrador l'anomenarem <span class="drop-zone inline-block bg-white border-2 border-dashed border-gray-400 rounded px-2 py-1 align-bottom min-w-[140px] h-[42px]" data-accept="intradiegetic"></span> i serà un <span class="drop-zone inline-block bg-white border-2 border-dashed border-gray-400 rounded px-2 py-1 align-bottom min-w-[140px] h-[42px]" data-accept="personatge"></span> de la història. Si expliquem la història des d'un punt de vista extern, tindrem un narrador <span class="drop-zone inline-block bg-white border-2 border-dashed border-gray-400 rounded px-2 py-1 align-bottom min-w-[140px] h-[42px]" data-accept="extradiegetic"></span>.
                        </p>
                        <div class="words-container flex flex-wrap gap-4 justify-center mb-6 min-h-[50px]">
                            <div class="drag-item bg-accent text-white font-medium px-4 py-2 rounded-lg shadow" draggable="true" data-word="personatge">personatge</div>
                            <div class="drag-item bg-accent text-white font-medium px-4 py-2 rounded-lg shadow" draggable="true" data-word="extradiegetic">extradiegètic</div>
                            <div class="drag-item bg-accent text-white font-medium px-4 py-2 rounded-lg shadow" draggable="true" data-word="intradiegetic">intradiegètic</div>
                        </div>
                        <div class="flex items-center gap-4 mt-6">
                            <button class="check-btn bg-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition">Verificar</button>
                            <button class="skip-btn hidden bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition">Saltar Activitat</button>
                            <p class="feedback-msg font-medium h-6"></p>
                        </div>
                    </div>
                </div>
            
                <!-- Activitat 2: Vocabulari -->
                <div class="activity-step hidden" data-step-id="vocabulari" data-step-title="Vocabulari de 'La nouvinguda'">
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h4 class="text-xl font-bold mb-1 text-primary">Activitat 2: Vocabulari de "La nouvinguda"</h4>
                        <p class="text-gray-600 mb-6">Relaciona cada paraula amb la seva definició arrossegant-la a la casella corresponent.</p>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div class="flex items-center bg-secondary/30 p-4 rounded-lg"><span class="drop-zone-vocab bg-white border-2 border-dashed border-gray-400 rounded-lg w-40 h-12 mr-4 flex-shrink-0 flex items-center justify-center" data-accept="nouvinguda"></span><p class="text-gray-700">Persona que acaba d'arribar a un lloc.</p></div>
                                <div class="flex items-center bg-secondary/30 p-4 rounded-lg"><span class="drop-zone-vocab bg-white border-2 border-dashed border-gray-400 rounded-lg w-40 h-12 mr-4 flex-shrink-0 flex items-center justify-center" data-accept="integracio"></span><p class="text-gray-700">Procés d'incorporar-se a un grup o societat.</p></div>
                                <div class="flex items-center bg-secondary/30 p-4 rounded-lg"><span class="drop-zone-vocab bg-white border-2 border-dashed border-gray-400 rounded-lg w-40 h-12 mr-4 flex-shrink-0 flex items-center justify-center" data-accept="identitat"></span><p class="text-gray-700">Conjunt de trets propis que caracteritzen una persona.</p></div>
                            </div>
                            <div class="words-container flex flex-col gap-4 justify-center items-center bg-gray-50 p-4 rounded-lg">
                                <div class="drag-item-vocab bg-accent text-white font-medium px-4 py-2 rounded-lg shadow w-full text-center" draggable="true" data-word="integracio">Integració</div>
                                <div class="drag-item-vocab bg-accent text-white font-medium px-4 py-2 rounded-lg shadow w-full text-center" draggable="true" data-word="identitat">Identitat</div>
                                <div class="drag-item-vocab bg-accent text-white font-medium px-4 py-2 rounded-lg shadow w-full text-center" draggable="true" data-word="nouvinguda">Nouvinguda</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 mt-6">
                            <button class="check-btn bg-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition">Verificar</button>
                            <button class="skip-btn hidden bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition">Saltar Activitat</button>
                            <p class="feedback-msg font-medium h-6"></p>
                        </div>
                    </div>
                </div>
            
                <!-- Activitat 3: Comprensió -->
                <div class="activity-step hidden" data-step-id="comprensio" data-step-title="Comprensió del relat">
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h4 class="text-xl font-bold mb-1 text-primary">Activitat 3: Comprensió del relat</h4>
                        <p class="text-gray-600 mb-6">Quin és el tema principal que explora el relat "La nouvinguda"?</p>
                        <div class="space-y-4 quiz-options">
                            <div class="quiz-option border-2 border-gray-200 p-4 rounded-lg" data-correct="false">Les dificultats de trobar feina en un país nou.</div>
                            <div class="quiz-option border-2 border-gray-200 p-4 rounded-lg" data-correct="true"> La denúncia de l'assetjament escolar</div>
                            <div class="quiz-option border-2 border-gray-200 p-4 rounded-lg" data-correct="false">Un conflicte familiar causat per un canvi de ciutat.</div>
                        </div>
                        <div class="flex items-center gap-4 mt-6">
                            <button class="check-btn bg-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition">Verificar</button>
                            <button class="skip-btn hidden bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition">Saltar Activitat</button>
                            <p class="feedback-msg font-medium h-6"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="completion-message" class="hidden text-center bg-green-100 border-l-4 border-green-500 text-green-700 p-6 rounded-lg shadow-lg">
                <h3 class="text-2xl font-bold mb-2">Enhorabona!</h3>
                <p class="text-lg mb-4">Has completat totes les activitats. Ja pots descarregar el teu justificant.</p>
                <div class="flex justify-center gap-4">
                    <button id="download-pdf-btn" class="bg-accent text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition"><i class="fas fa-file-pdf mr-2"></i>Descarregar PDF</button>
                    <button id="restart-level-btn" class="bg-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition">Tornar a començar</button>
                </div>
            </div>
        </div>
    </div>
</main>

<footer class="bg-primary text-white py-8">
    <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="mb-6 md:mb-0">
                <div class="text-2xl font-bold text-secondary mb-2">Afers Juvenils</div>
                <p class="text-gray-400">© 2025 Maria Dolors Añón. Tots els drets reservats.</p>
            </div>
            <div class="flex space-x-6">
                <a href="https://www.instagram.com/anondolors" target="_blank" class="text-gray-400 hover:text-accent"><i class="fab fa-instagram text-xl"></i></a>
                <a href="https://www.facebook.com/dolors.anon" target="_blank" class="text-gray-400 hover:text-accent"><i class="fab fa-facebook text-xl"></i></a>
                <a href="mailto:manon@xtec.cat" class="text-gray-400 hover:text-accent"><i class="fas fa-envelope text-xl"></i></a>
            </div>
        </div>
    </div>
</footer>

<!-- Libreria jsPDF para generar el PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- El teu script personalitzat (reutilitzable) -->
<script>
    document.addEventListener('DOMContentLoaded', function() {

    // --- FUNCIONALITAT GLOBAL (S'executa a totes les pàgines) ---
    const menuToggle = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    if (menuToggle && mobileMenu) {
        menuToggle.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
    }

    const currentPage = window.location.pathname.split('/').pop() || 'index.html';
    document.querySelectorAll('header nav a.nav-link, #mobile-menu a').forEach(link => {
        if (link.getAttribute('href') === currentPage || (currentPage.startsWith('activitats-') && link.getAttribute('href') === 'activitats.html')) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });

    // --- LÒGICA PRINCIPAL DE LES PÀGINES D'ACTIVITATS ---
    const activityWrapper = document.getElementById('activity-wrapper');
    if (activityWrapper) {
        
        let activityState = {
            userName: '',
            storyId: activityWrapper.dataset.storyId,
            storyTitle: activityWrapper.dataset.storyTitle,
            levelText: activityWrapper.dataset.levelText,
            currentStepIndex: 0,
            totalSteps: 0,
            activityResults: [] // Cada element contindrà { title, userAnswer, isCorrect, attempts }
        };

        // --- Elements del DOM ---
        const nameInputContainer = document.getElementById('name-input-container');
        const mainActivityContent = document.getElementById('main-activity-content');
        const completionMessage = document.getElementById('completion-message');
        const studentNameInput = document.getElementById('student-name');
        const startActivitiesBtn = document.getElementById('start-activities-btn');

        const activitySet = activityWrapper.querySelector('.activity-set');
        const steps = activitySet.querySelectorAll('.activity-step');

        const startActivities = () => {
            activityState.userName = studentNameInput.value.trim();
            if (!activityState.userName) return;

            nameInputContainer.classList.add('hidden');
            mainActivityContent.classList.remove('hidden');
            initializeActivitySet();
        };

        const initializeActivitySet = () => {
            activityState.currentStepIndex = 0;
            activityState.activityResults = Array.from({ length: steps.length }, () => ({
                title: '', // Es definirà en saveResult
                userAnswer: "No s'ha respost",
                isCorrect: false,
                attempts: 0
            }));
            activityState.totalSteps = steps.length;

            steps.forEach((step, index) => {
                step.classList.toggle('hidden', index !== 0);
                resetActivityStep(step); // Reseteja cada activitat al començament
            });
            updateProgressBar();
        };

    const resetActivityStep = (step) => {
        const feedbackMsg = step.querySelector('.feedback-msg');
        let checkBtn = step.querySelector('.check-btn');
        let skipBtn  = step.querySelector('.skip-btn');

        // Reset missatge i estils
        feedbackMsg.textContent = '';
        feedbackMsg.className = 'feedback-msg font-medium h-6';

        // Estat visual dels botons principals
        if (checkBtn) {
            checkBtn.textContent = 'Verificar';
            checkBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'hidden');
            checkBtn.classList.add('bg-primary', 'hover:bg-opacity-90');
            checkBtn.disabled = false;
        }
        if (skipBtn) {
            skipBtn.classList.add('hidden'); // per defecte amagat
        }

        // Treu botons dinàmics previs (retry, next, next-correct)
        step.querySelector('.retry-btn')?.remove();
        step.querySelector('.next-btn')?.remove();
        step.querySelector('.next-correct-btn')?.remove();

        // ❌ Elimina qualsevol listener antic clonant els botons
        if (checkBtn) {
            const newCheck = checkBtn.cloneNode(true);
            checkBtn.parentNode.replaceChild(newCheck, checkBtn);
            checkBtn = newCheck;
            // ✅ Afegeix un sol listener
            checkBtn.addEventListener('click', () => handleCheck(step));
        }

        if (skipBtn) {
            const newSkip = skipBtn.cloneNode(true);
            skipBtn.parentNode.replaceChild(newSkip, skipBtn);
            skipBtn = newSkip;
            // ✅ Un sol listener
            skipBtn.addEventListener('click', () => handleSkip(step));
        }

        // Re-inicialitza el contingut específic de cada tipus d’activitat
        if (step.querySelector('.quiz-options')) {
            initializeQuiz(step);
        }
        if (step.querySelector('.drop-zone, .drop-zone-vocab')) {
            initializeDragAndDrop(step);
            // Reinicialitza DnD per aquest pas (events nets i actuals)
            setupDragAndDropForStep(step);
        }
    };

        const updateProgressBar = () => {
            const progress = activityState.totalSteps > 0 ? (activityState.currentStepIndex / activityState.totalSteps) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `Pas ${activityState.currentStepIndex + 1} / ${activityState.totalSteps}`; // +1 per mostrar pas actual real
        };

        const goToNextStep = () => {
            if (activityState.currentStepIndex < activityState.totalSteps) {
                steps[activityState.currentStepIndex].classList.add('hidden');
            }
            activityState.currentStepIndex++;
            updateProgressBar();

            if (activityState.currentStepIndex < activityState.totalSteps) {
                steps[activityState.currentStepIndex].classList.remove('hidden');
                resetActivityStep(steps[activityState.currentStepIndex]); // Reseteja el següent pas
            } else {
                document.getElementById('progress-text').textContent = `Completat!`;
                completionMessage.classList.remove('hidden');
            }
        };

        const handleCheck = (step) => {
            const currentResult = activityState.activityResults[activityState.currentStepIndex];
            currentResult.attempts++; // Incrementa el contador d'intents

            let result = { correct: false, answer: "No s'ha respost" };
            if (step.querySelector('.quiz-options')) result = checkQuiz(step);
            if (step.querySelector('.drop-zone, .drop-zone-vocab')) result = checkDragAndDrop(step);

            const feedbackMsg = step.querySelector('.feedback-msg');
            const checkBtn = step.querySelector('.check-btn');
            const skipBtn = step.querySelector('.skip-btn');
            
            saveResult(step, result.answer, result.correct); // Guarda l'últim intent

            if (result.correct) {
                feedbackMsg.textContent = 'Molt bé! Resposta correcta.';
                feedbackMsg.className = 'feedback-msg font-medium h-6 text-green-600';
                
                // Ocultar el botó verificar i skip
                checkBtn.classList.add('hidden');
                skipBtn.classList.add('hidden');
                
                // Crear el botó "Següent activitat" si no existeix
                let nextBtn = step.querySelector('.next-correct-btn');
                if (!nextBtn) {
                    nextBtn = document.createElement('button');
                    nextBtn.className = 'next-correct-btn bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition';
                    //nextBtn.textContent = 'Següent activitat';
                    checkBtn.parentNode.insertBefore(nextBtn, feedbackMsg);
                }

                // 🟢 Si és l'última activitat, mostra "Acabar nivell"; si no, "Següent activitat"
                const isLastStep = activityState.currentStepIndex === activityState.totalSteps - 1;
                nextBtn.textContent = isLastStep ? 'Acabar nivell' : 'Següent activitat';

                nextBtn.onclick = () => {
                    goToNextStep(); // mateixa lògica de sempre
                };
            } else {
                feedbackMsg.textContent = 'Hi ha alguns errors. Revisa les respostes marcades en vermell.';
                feedbackMsg.className = 'feedback-msg font-medium h-6 text-red-600';
                
                // Ocultar el botó verificar i mostrar els dos nous botons
                checkBtn.classList.add('hidden');
                skipBtn.classList.add('hidden');
                
                // Crear els nous botons si no existeixen
                let retryBtn = step.querySelector('.retry-btn');
                let nextBtn = step.querySelector('.next-btn');
                
                if (!retryBtn) {
                    retryBtn = document.createElement('button');
                    retryBtn.className = 'retry-btn bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-600 transition mr-4';
                    retryBtn.textContent = 'Tornar-ho a intentar';
                    checkBtn.parentNode.insertBefore(retryBtn, feedbackMsg);
                    
                    retryBtn.addEventListener('click', () => {
                        resetActivityStep(step);
                        retryBtn.remove();
                        nextBtn.remove();
                    });
                }
                
                if (!nextBtn) {
                    nextBtn = document.createElement('button');
                    nextBtn.className = 'next-btn bg-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition';
                    nextBtn.textContent = 'Següent activitat';
                    checkBtn.parentNode.insertBefore(nextBtn, feedbackMsg);
                    
                    nextBtn.addEventListener('click', () => {
                        saveResult(step, result.answer, false); // Marca com incorrecte
                        goToNextStep();
                    });
                }
            }
        };
        
        const handleSkip = (step) => {
             const currentResult = activityState.activityResults[activityState.currentStepIndex];
             currentResult.attempts++; // També incrementa si es salta
             saveResult(step, 'Saltat', false);
             goToNextStep();
        };

        const saveResult = (step, answer, isCorrect) => {
            const title = step.dataset.stepTitle || `Activitat ${activityState.currentStepIndex + 1}`;
            activityState.activityResults[activityState.currentStepIndex] = { 
                title: title, 
                userAnswer: answer, 
                isCorrect: isCorrect,
                attempts: activityState.activityResults[activityState.currentStepIndex].attempts // Manté el contador d'intents
            };
        };

        const initializeDragAndDrop = (container) => {
            // Torna tots els elements arrossegables al seu contenidor original
            const wordsContainer = container.querySelector('.words-container');
            const originalWords = []; // Per mantenir l'ordre original
            
            // Recollir tots els elements drag existents (tant dels drop zones com del words container)
            container.querySelectorAll('.drag-item, .drag-item-vocab').forEach(item => {
                originalWords.push({
                    element: item.cloneNode(true), // Clonar per evitar duplicats
                    word: item.dataset.word,
                    text: item.textContent.trim()
                });
            });

            // Neteja completament les drop zones
            container.querySelectorAll('.drop-zone, .drop-zone-vocab').forEach(zone => {
                zone.innerHTML = '';
                zone.classList.remove('correct-drop', 'incorrect-drop', 'highlight');
            });
            
            // Neteja el contenidor de paraules
            wordsContainer.innerHTML = '';
            
            // Afegeix els elements originals de nou al wordsContainer
            originalWords.forEach(item => {
                const newElement = item.element;
                newElement.dataset.word = item.word;
                newElement.textContent = item.text;
                wordsContainer.appendChild(newElement);
            });
        };
        
        const checkDragAndDrop = (step) => {
            let allCorrect = true;
            let answers = [];
            const dropZones = step.querySelectorAll('.drop-zone, .drop-zone-vocab');
            dropZones.forEach(zone => {
                zone.classList.remove('correct-drop', 'incorrect-drop');
                const droppedItem = zone.querySelector('.drag-item, .drag-item-vocab');
                const word = droppedItem ? droppedItem.textContent.trim() : 'Buit';
                answers.push(`${zone.dataset.accept}: ${word}`); // Per al PDF, mostrar què s'esperava vs què es va posar
                if (!droppedItem || droppedItem.dataset.word !== zone.dataset.accept) {
                    allCorrect = false;
                    zone.classList.add('incorrect-drop');
                } else {
                    zone.classList.add('correct-drop');
                }
            });
            return { correct: allCorrect, answer: answers.join('; ') };
        };

        const initializeQuiz = (container) => {
            container.querySelectorAll('.quiz-option').forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect');
                // Reassignar event listeners per evitar duplicats
                const newOption = option.cloneNode(true);
                option.parentNode.replaceChild(newOption, option);
            });
            
            // Reassignar event listeners després de clonar
            container.querySelectorAll('.quiz-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Desselecciona totes les opcions
                    container.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
                    // Selecciona l'opció actual
                    this.classList.add('selected');
                });
            });
        };
        
        const checkQuiz = (step) => {
            const selectedOption = step.querySelector('.quiz-option.selected');
            step.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('correct', 'incorrect'));
            
            if (!selectedOption) return { correct: false, answer: "No s'ha respost" };

            const isCorrect = selectedOption.dataset.correct === 'true';
            
            if (isCorrect) {
                selectedOption.classList.add('correct');
            } else {
                selectedOption.classList.add('incorrect');
                // Mostrar la resposta correcta si no s'ha encertat
                //step.querySelector('.quiz-option[data-correct="true"]').classList.add('correct');
            }
            
            return { correct: isCorrect, answer: selectedOption.textContent.trim() };
        };
        
        // ───────────────────────────────────────────────────────────────
        // Nova versió de generatePDF amb enunciats i respostes clares
        // ───────────────────────────────────────────────────────────────
        const generatePDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'mm', format: 'a4' });

            const today = new Date().toLocaleDateString('ca-ES');

            // Marges i control de línia
            const marginX = 14;
            const contentWidth = 180; // 210 - 2*15 aprox.
            let y = 20;

            // Capçalera
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.text("Justificant d'Activitats - Afers Juvenils", 105, y, { align: 'center' });
            y += 12;

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(12);
            doc.text(`Alumne/a: ${activityState.userName}`, marginX, y);
            doc.text(`Data: ${today}`, 210 - marginX, y, { align: 'right' });
            y += 7;
            doc.text(`Relat: ${activityState.storyTitle}`, marginX, y);
            y += 7;
            doc.text(`Nivell: ${activityState.levelText}`, marginX, y);
            y += 8;

            doc.line(marginX, y, 210 - marginX, y);
            y += 6;

            let correctAnswers = 0;

            // Recorre totes les activitats
            const steps = document.querySelectorAll('#activity-wrapper .activity-set .activity-step');

            activityState.activityResults.forEach((result, idx) => {
                // Salt de pàgina si cal
                const ensureSpace = (needed = 10) => {
                    if (y + needed > 287) { // marge inferior ~ 287
                        doc.addPage();
                        y = 20;
                    }
                };

                ensureSpace(14);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(13);
                doc.text(`Activitat ${idx + 1}: ${result.title}`, marginX, y);
                y += 6;

                // ENUNCIAT
                const step = steps[idx];
                const enunciat = getActivityEnunciat(step) || '(Enunciat no disponible)';
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text('Enunciat:', marginX, y);
                y += 5;

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(11);
                const enuncLines = doc.splitTextToSize(enunciat, contentWidth);
                enuncLines.forEach(line => {
                    ensureSpace(6);
                    doc.text(line, marginX, y);
                    y += 5;
                });

                y += 2;

                // RESPOSTA DE L'ALUMNE
                const readableAnswer = getStudentAnswerReadable(step) || result.userAnswer || "No s'ha respost";
                doc.setFont('helvetica', 'bold');
                doc.text('Resposta de l’alumne:', marginX, y);
                y += 5;

                doc.setFont('helvetica', 'normal');
                const ansLines = doc.splitTextToSize(readableAnswer, contentWidth);
                ansLines.forEach(line => {
                    ensureSpace(6);
                    doc.text(line, marginX, y);
                    y += 5;
                });

                y += 2;

                // Estat + Intents
                let statusText = '';
                let color = [0,0,0];

                if (result.isCorrect) {
                    statusText = 'Resultat: Correcte ✓';
                    color = [34, 139, 34];
                    correctAnswers++;
                } else if (result.userAnswer === 'Saltat') {
                    statusText = 'Resultat: Saltat';
                    color = [100, 100, 100];
                } else {
                    statusText = 'Resultat: Incorrecte ✗';
                    color = [220, 20, 60];
                }

                ensureSpace(10);
                doc.setTextColor(color[0], color[1], color[2]);
                doc.text(statusText, marginX, y);
                doc.setTextColor(0,0,0);
                doc.text(`Intents: ${result.attempts}`, 210 - marginX, y, { align: 'right' });
                y += 7;

                doc.setDrawColor(200);
                doc.line(marginX, y, 210 - marginX, y);
                y += 6;
            });

            // Puntuació final
            const score = Math.round((correctAnswers / activityState.totalSteps) * 100);
            const finalText = `Puntuació Final: ${score}% (${correctAnswers} de ${activityState.totalSteps} correctes)`;

            if (y + 12 > 287) { doc.addPage(); y = 20; }
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text(finalText, 105, y, { align: 'center' });

            // Nom del fitxer
            const fileName = `Justificant_${activityState.userName.replace(/ /g, '_')}_${activityState.storyId}.pdf`;
            doc.save(fileName);
        };


        // ───────────────────────────────────────────────────────────────
        // Helpers per extreure Enunciat i Resposta de cada activitat
        // ───────────────────────────────────────────────────────────────
        function getActivityEnunciat(step) {
            // 1) Drag & Drop frase (té .drop-zone dins un paràgraf)
            const sentenceP = step.querySelector('p .drop-zone')?.closest('p');
            if (sentenceP) {
                const clone = sentenceP.cloneNode(true);
                clone.querySelectorAll('.drop-zone').forEach(z => { z.textContent = '____'; });
                return clone.innerText.trim();
            }

            // 2) Vocabulari (té .drop-zone-vocab i definicions)
            const vocabRows = step.querySelectorAll('.drop-zone-vocab');
            if (vocabRows.length) {
                const lines = [];
                vocabRows.forEach(z => {
                    const defText = z.parentElement.querySelector('p')?.innerText?.trim() || '';
                    lines.push(`[____] — ${defText}`);
                });
                return lines.join('\n');
            }

            // 3) Quiz (pregunta + opcions)
            const question = step.querySelector('p')?.innerText?.trim() || '';
            const options = Array.from(step.querySelectorAll('.quiz-option')).map((opt, i) => {
                // Lletres A, B, C...
                const letter = String.fromCharCode(65 + i);
                return `${letter}) ${opt.innerText.trim()}`;
            });
            return [question, ...options].join('\n');
        }

        function getStudentAnswerReadable(step) {
            // 1) Drag & Drop frase (substituir drop-zones pel que ha triat l’alumne)
            const sentenceP = step.querySelector('p .drop-zone')?.closest('p');
            if (sentenceP) {
                const clone = sentenceP.cloneNode(true);
                clone.querySelectorAll('.drop-zone').forEach(z => {
                    const chosen = z.querySelector('.drag-item');
                    z.textContent = chosen ? chosen.innerText.trim() : '—';
                });
                return clone.innerText.trim();
            }

            // 2) Vocabulari: línies [paraula] — definició
            const vocabRows = step.querySelectorAll('.drop-zone-vocab');
            if (vocabRows.length) {
                const lines = [];
                vocabRows.forEach(z => {
                    const chosen = z.querySelector('.drag-item-vocab')?.innerText?.trim() || '—';
                    const defText = z.parentElement.querySelector('p')?.innerText?.trim() || '';
                    lines.push(`[${chosen}] — ${defText}`);
                });
                return lines.join('\n');
            }

            // 3) Quiz: opció seleccionada
            const selected = step.querySelector('.quiz-option.selected') 
                        || step.querySelector('.quiz-option.correct') 
                        || step.querySelector('.quiz-option.incorrect');
            return selected ? selected.innerText.trim() : 'No s’ha respost';
        }


        // --- Assignació d'esdeveniments ---
        studentNameInput.addEventListener('input', () => {
            startActivitiesBtn.disabled = studentNameInput.value.trim() === '';
        });
        startActivitiesBtn.addEventListener('click', startActivities);

        // Aquests listeners han de ser delegats o re-assignats en cada 'resetActivityStep' per als botons dinàmics
        /*steps.forEach(step => {
            // El listener per `check-btn` és dinàmic i es reassigna a `handleCheck` o `resetActivityStep`
            step.querySelector('.check-btn')?.addEventListener('click', function() {
                if (this.textContent === 'Verificar') {
                    handleCheck(step);
                } else if (this.textContent === 'Tornar a intentar-ho') {
                    resetActivityStep(step);
                    this.textContent = 'Verificar'; // Restaura el text
                    this.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    this.classList.add('bg-primary', 'hover:bg-opacity-90'); // Restaura classes originals
                }
            });

            // Event listener per al botó Skip
            step.querySelector('.skip-btn')?.addEventListener('click', () => handleSkip(step));
        }); 
        */
        // Funcionalitat de drag and drop
        const setupDragAndDrop = () => {
            steps.forEach(step => {
                if (step.querySelector('.drop-zone, .drop-zone-vocab')) {
                    setupDragAndDropForStep(step);
                }
            });
        };

        const setupDragAndDropForStep = (step) => {
            // Neteja event listeners existents per evitar duplicats
            step.querySelectorAll('.drag-item, .drag-item-vocab').forEach(item => {
                // Clona l'element per eliminar tots els event listeners
                const newItem = item.cloneNode(true);
                item.parentNode.replaceChild(newItem, item);
            });

            step.querySelectorAll('.drag-item, .drag-item-vocab').forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.word);
                    e.dataTransfer.setData('text/html', this.outerHTML);
                    e.dataTransfer.effectAllowed = 'move';
                    this.classList.add('opacity-50');
                });

                item.addEventListener('dragend', function() {
                    this.classList.remove('opacity-50');
                });
            });

            step.querySelectorAll('.drop-zone, .drop-zone-vocab').forEach(zone => {
                // Clona per eliminar event listeners existents
                const newZone = zone.cloneNode(true);
                zone.parentNode.replaceChild(newZone, zone);
            });

            // Reassignar després de clonar
            step.querySelectorAll('.drop-zone, .drop-zone-vocab').forEach(zone => {
                zone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    this.classList.add('highlight');
                });

                zone.addEventListener('dragleave', function() {
                    this.classList.remove('highlight');
                });

                zone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('highlight');
                    
                    const draggedWord = e.dataTransfer.getData('text/plain');
                    const draggedHTML = e.dataTransfer.getData('text/html');
                    
                    // Si ja hi ha un element, l'envia de tornada al contenidor de paraules
                    if (this.firstElementChild) {
                        const wordsContainer = step.querySelector('.words-container');
                        wordsContainer.appendChild(this.firstElementChild);
                    }
                    
                    // Crear un nou element des del HTML arrossegat
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = draggedHTML;
                    const newElement = tempDiv.firstElementChild;
                    
                    // Afegir el nou element a la zona de drop
                    this.appendChild(newElement);
                    
                    // Eliminar l'element original del contenidor de paraules
                    const originalElement = step.querySelector(`.words-container [data-word="${draggedWord}"]`);
                    if (originalElement) {
                        originalElement.remove();
                    }
                    
                    // Reassignar drag events al nou element
                    setupDragAndDropForStep(step);
                });
            });
        };

        // Event listeners per als botons finals
        document.getElementById('download-pdf-btn')?.addEventListener('click', generatePDF);
        document.getElementById('restart-level-btn')?.addEventListener('click', () => {
            completionMessage.classList.add('hidden');
            mainActivityContent.classList.add('hidden');
            nameInputContainer.classList.remove('hidden');
            studentNameInput.value = '';
            startActivitiesBtn.disabled = true;
        });

        // Inicialitzar funcionalitat de drag and drop
        setupDragAndDrop();
    }
});
</script>
</body>
</html>